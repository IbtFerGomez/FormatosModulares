<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>FO-LC-20 Procesamiento</title>
    <link rel="stylesheet" href="format-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="format-app.js"></script>
    <style>
        /* Estilos específicos para tabla compleja */
        #freeze-table th {
            vertical-align: middle;
            text-align: center;
            font-size: 10px;
            background-color: #f8f9fa;
        }
        .sub-header th {
            font-size: 9px;
            background-color: #e9ecef !important;
            padding: 4px;
        }
        /* Resaltar campos autogenerados */
        .auto-generated {
            background-color: #f0f4f8;
            font-weight: bold;
            color: #333;
            font-family: 'Consolas', 'Monaco', monospace;
        }
    </style>
</head>
<body id="doc-fo-lc-20">
    <div class="global-controls no-print">
        <button class="btn btn-success" onclick="saveForm()">Guardar</button>
        <button class="btn btn-primary" onclick="printForm()">Imprimir</button>
        <button class="btn btn-danger" onclick="clearForm()">Limpiar</button>
    </div>

    <div class="container">
        <div class="header-top">
            <div class="logo-container">
                <svg viewBox="0 0 320 80"><defs><style>.svg-logo-titulo{font-family:'Arial Black',sans-serif;font-weight:900;fill:#1D1D1B}.svg-logo-subtitulo{font-family:'Arial',sans-serif;font-weight:700;fill:#1D1D1B;letter-spacing:2px}.svg-logo-celula{fill:#2E9D82}</style></defs><g transform="translate(0, -2) scale(0.85)"><circle class="svg-logo-celula" cx="25" cy="25" r="13"/><circle class="svg-logo-celula" cx="75" cy="75" r="13"/><path class="svg-logo-celula" d="M15.81,65.81C28.54,53.08 33.74,59.19 46.46,46.46C59.19,33.74 53.08,28.54 65.81,15.81A13 13 0 1 1 84.19,34.19C71.46,46.92 66.26,40.81 53.54,53.54C40.81,66.26 46.92,71.46 34.19,84.19A13 13 0 1 1 15.81,65.81Z"/></g><text x="90" y="42" class="svg-logo-titulo" font-size="34">XELLE</text><text x="91" y="68" class="svg-logo-subtitulo" font-size="19">SCIENTIFIC</text><text x="215" y="35" font-family="Arial" font-size="10" fill="#1D1D1B">®</text></svg>
            </div>
            <div class="registry-container">
                <label>No. Registro</label>
                <div class="registry-wrapper">
                    <span class="registry-prefix">FO-LC-20-</span>
                    <input type="text" id="reg-20" class="registry-input generate-barcode" data-target="barcode-20" data-prefix="FO-LC-20-">
                </div>
                <input type="date" class="registry-date no-auto-date">
                <svg id="barcode-20" class="barcode-svg"></svg>
            </div>
        </div>

        <div class="header-main">
            <h1>FORMATO PROCESAMIENTO DE PLACENTA Y CULTIVO INICIAL.</h1>
            <div class="metadata">Código: FO-LC-20 | Versión: 1.0 | Vig: Ene2026</div>
        </div>

        <div class="section">
            <div class="section-title">1. Datos del Proceso</div>
            <table class="no-border-table">
                <tr>
                    <td width="15%"><strong>ID Donante:</strong></td>
                    <td width="35%"><input type="text" id="id_donante" class="cedit"></td>
                    <td width="15%"><strong>ID Placenta (TPL):</strong></td>
                    <td width="35%"><input type="text" id="tpl-id-input" placeholder="TPL..." class="cedit" style="font-weight:bold; color: #2980b9;" oninput="updateAllCodes()"></td>
                </tr>
                <tr>
                    <td><strong>Fecha Proceso:</strong></td>
                    <td><input type="date" class="today-date cedit" id="fecha_proceso" onchange="updateAllCodes()"></td>
                    <td><strong>Hora Proceso:</strong></td>
                    <td><input type="time" class="cedit"></td>
                </tr>
                <tr>
                    <td><strong>Responsable:</strong></td>
                    <td colspan="3"><input type="text" id="responsable_proceso" class="cedit"></td>
                </tr>
            </table>
            
            <div style="margin-top: 10px; padding: 10px; background-color: #f9f9f9; border: 1px solid #eee;">
                <strong>Método de Aislamiento:</strong>
                <div style="display:inline-flex; gap:20px; margin-left:10px;">
                    <label><input type="checkbox" id="met_exp" onchange="syncMethod('EX')"> Explantes (EXP)</label>
                    <label><input type="checkbox" id="met_dig" onchange="syncMethod('DG')"> Digestión Enzimática (DIG)</label>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">2. Insumos <button class="btn btn-primary btn-mini no-print" onclick="addSupplyRow()">+ Insumo</button></div>
            <table>
                <thead><tr><th width="30%">Insumo</th><th width="25%">Marca</th><th width="25%">Lote</th><th width="15%">Caducidad</th><th class="no-print"></th></tr></thead>
                <tbody id="supplies-table-body"></tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">3. Inicio de Cultivo (Siembra)</div>
            <table id="flask-table">
                <thead>
                    <tr>
                        <th width="18%">ID Trazable (Origen)</th>
                        <th width="8%">Tipo</th>
                        <th width="10%">FI</th>
                        <th width="5%">#</th>
                        <th width="25%">Código Generado</th>
                        <th width="12%">Recipiente</th>
                        <th width="5%" class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="flask-table-body"></tbody>
            </table>
            <button class="btn btn-primary no-print" onclick="addFlaskRowFiltered()" style="margin-top: 5px;">+ Agregar Flask</button>
        </div>

        <div class="section">
            <div class="section-title">4. Congelación Inicial</div>
            <div style="margin-bottom: 10px;">
                <strong>¿Se congeló muestra?</strong>
                <select id="freeze-select" style="width: 200px; margin-left: 10px; font-weight: bold;" onchange="toggleFreezeLocal()">
                    <option value="No">No</option><option value="Si">Sí</option>
                </select>
            </div>
            <div id="freeze-container" style="display:none;">
                <table id="freeze-table" class="compact-table">
                    <thead>
                        <tr>
                            <th rowspan="2" width="12%">C. Origen</th>
                            <th rowspan="2" width="5%">Cant.</th>
                            <th rowspan="2" width="8%">Conc. Cel</th>
                            <th rowspan="2" width="8%">Pres.</th>
                            <th colspan="4" width="35%" style="border-bottom:1px solid #ccc;">Datos de Insumo</th>
                            <th rowspan="2" width="6%">Viab %</th>
                            <th rowspan="2" width="5%">Pas.</th>
                            <th rowspan="2" width="15%">CÓDIGO ÚNICO</th>
                            <th rowspan="2" class="no-print"></th>
                        </tr>
                        <tr class="sub-header">
                            <th>Insumo</th>
                            <th>Lote</th>
                            <th>Vol</th>
                            <th>V.Tot</th>
                        </tr>
                    </thead>
                    <tbody id="freeze-table-body"></tbody>
                </table>
                <button class="btn btn-primary no-print" onclick="addFreezeRowDual()">+ Agregar Lote</button>
            </div>
        </div>

        <div class="signature-area">
            <div class="signature-box"><p>Realizó:</p><input type="text"><p>Firma</p></div>
            <div class="signature-box"><p>Verificó:</p><input type="text"><p>Firma</p></div>
        </div>
        <div class="footer">FO-LC-20 | Versión: 1.0 | Vigente a partir de: Enero2026<br>El contenido de este documento es propiedad 
            de “Xelle Scientific”, S.A.P.I., de C. V., y está protegido por los derechos de autor, por lo que está prohibida su reproducción total o parcial.</div>
    </div>

    <script>
        // --- UTILIDADES ---
        function getFormattedDateDDMMYY(dateString) {
            if (!dateString) return '';
            const [y, m, d] = dateString.split('-');
            return `${d}${m}${y.slice(2)}`;
        }

        function updateAllCodes() {
            // Actualizar Tabla Cultivo
            document.querySelectorAll('#flask-table-body tr').forEach(row => autoGenFlaskCode(row));
            // Actualizar Opciones en Congelación
            updateOriginOptions();
            // Actualizar Códigos Congelación
            document.querySelectorAll('#freeze-table-body tr').forEach(row => {
                if(row.querySelector('.origin-select')) autoGenFreezeCode(row.querySelector('.origin-select'));
            });
        }

        // --- SECCIÓN 1: SINCRONIZACIÓN ---
        function syncMethod(type) {
            const rows = document.querySelectorAll('#flask-table-body tr');
            rows.forEach(row => {
                const select = row.querySelector('.type-select');
                if(select) {
                    select.value = type;
                    autoGenFlaskCode(row);
                }
            });
            updateAllCodes();
        }

        // --- SECCIÓN 3: CULTIVO ---
        function addFlaskRowFiltered() {
            const tbody = document.getElementById('flask-table-body');
            const row = document.createElement('tr');
            
            // Opciones de Recipiente
            const recipientOptions = `
                <option value="T-25">T-25</option>
                <option value="T-75">T-75</option>
                <option value="T-175">T-175</option>
                <option value="T-225">T-225</option>
                <option value="HyperFlask">HyperFlask</option>
                <option value="CS-1">CellStack 1</option>
                <option value="CS-2">CellStack 2</option>
                <option value="CS-5">CellStack 5</option>
            `;

            row.innerHTML = `
                <td><input class="cedit id-trazable auto-generated" readonly></td>
                <td>
                    <select class="cedit type-select" onchange="updateAllCodes()">
                        <option value="DG">DG</option>
                        <option value="EX">EX</option>
                    </select>
                </td>
                <td><input type="date" class="cedit fi-date" onchange="updateAllCodes()"></td>
                <td><input type="number" class="cedit num-flask" value="1" style="width:40px" oninput="updateAllCodes()"></td>
                <td><input class="cedit gen-code auto-generated" readonly></td>
                <td><select class="cedit recip-select" onchange="updateAllCodes()">${recipientOptions}</select></td>
                <td class="no-print"><button class="btn btn-danger btn-mini" onclick="removeFlaskRow(this)">x</button></td>
            `;
            
            // Heredar fecha del proceso si existe
            const mainDate = document.getElementById('fecha_proceso').value;
            if(mainDate) row.querySelector('.fi-date').value = mainDate;

            tbody.appendChild(row);
            updateAllCodes();
        }

        function removeFlaskRow(btn) {
            btn.closest('tr').remove();
            updateAllCodes();
        }

        function autoGenFlaskCode(rowOrEl) {
            const row = rowOrEl.closest ? rowOrEl.closest('tr') : rowOrEl;
            if(!row) return;

            const tpl = document.getElementById('tpl-id-input').value.trim() || 'TPL';
            const tipo = row.querySelector('.type-select').value;
            const fi = row.querySelector('.fi-date').value;
            const num = row.querySelector('.num-flask').value;
            const recip = row.querySelector('.recip-select').value;
            
            let recipCode = recip;
            if(recip === 'HyperFlask') recipCode = 'HF';

            const dateCode = getFormattedDateDDMMYY(fi);

            // 1. ID Trazable: LINEA - 20 - TIPO - NUM - FI
            const idTrazable = `${tpl}-20${tipo}-${num}-${dateCode}`;
            row.querySelector('.id-trazable').value = idTrazable;

            // 2. Codigo Generado: LINEA - TIPO - P0 - NUM - RECIPCODE - FI
            const genCode = `${tpl}-${tipo}-P0-${num}-${recipCode}-${dateCode}`;
            row.querySelector('.gen-code').value = genCode;
        }

        // --- SECCIÓN 4: CONGELACIÓN ---
        function updateOriginOptions() {
            const ids = [];
            document.querySelectorAll('#flask-table-body .id-trazable').forEach(input => {
                if(input.value) ids.push(input.value);
            });
            
            document.querySelectorAll('.origin-select').forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">- Sel -</option>';
                ids.forEach(id => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = id;
                    select.appendChild(opt);
                });
                if(ids.includes(currentVal)) select.value = currentVal;
            });
        }

        function addFreezeRowDual() {
            const tbody = document.getElementById('freeze-table-body');
            
            let optionsHtml = '<option value="">- Sel -</option>';
            document.querySelectorAll('#flask-table-body .id-trazable').forEach(input => {
                if(input.value) optionsHtml += `<option value="${input.value}">${input.value}</option>`;
            });

            const row1 = document.createElement('tr');
            row1.innerHTML = `
                <td rowspan="2"><select class="cedit origin-select" onchange="autoGenFreezeCode(this)">${optionsHtml}</select></td>
                <td rowspan="2"><input type="number" class="cedit cant-vials" value="1" oninput="autoGenFreezeCode(this)"></td>
                <td rowspan="2"><input class="cedit" placeholder="x10^6"></td>
                <td rowspan="2">
                    <select class="cedit type-vial" onchange="autoGenFreezeCode(this)">
                        <option value="CV-4ml">CV-4ml</option>
                        <option value="CV-2ml">CV-2ml</option>
                    </select>
                </td>
                
                <td><input class="cedit" value="DMSO" readonly style="text-align:center; font-weight:bold; background:#eef;"></td>
                <td><input class="cedit" placeholder="Lote DMSO"></td>
                <td><input type="number" class="cedit" step="0.1"></td>
                
                <td rowspan="2"><input type="number" class="cedit" step="0.1" style="font-weight:bold;"></td>
                <td rowspan="2"><input type="number" class="cedit" max="100"></td>
                <td rowspan="2"><input class="cedit" value="P0" readonly></td>
                
                <td rowspan="2"><textarea class="cedit gen-freeze-code auto-generated" rows="1" style="font-size:10px; height:auto; overflow:hidden;"></textarea></td>
                
                <td rowspan="2" class="no-print"><button class="btn btn-danger btn-mini" onclick="removeFreezeGroup(this)">x</button></td>
            `;
            
            const row2 = document.createElement('tr');
            row2.innerHTML = `
                <td><input class="cedit" value="MC" readonly style="text-align:center; font-weight:bold; background:#eef;"></td>
                <td><input class="cedit" placeholder="Lote MC"></td>
                <td><input type="number" class="cedit" step="0.1"></td>
            `;

            tbody.appendChild(row1);
            tbody.appendChild(row2);
            
            autoGenFreezeCode(row1.querySelector('.origin-select'));
        }

        function removeFreezeGroup(btn) {
            const row1 = btn.closest('tr');
            const row2 = row1.nextElementSibling;
            if (row2 && row2.cells.length === 3) row2.remove();
            row1.remove();
        }

        // LÓGICA DE GENERACIÓN CÓDIGO ÚNICO (V2.7)
        function autoGenFreezeCode(el) {
            const row = el.closest('tr');
            if(!row || !row.querySelector('.origin-select')) return;

            const originVal = row.querySelector('.origin-select').value; // Ej: TPL32-20DG-2-290126
            const typeVal = row.querySelector('.type-vial').value; 
            const typeCode = (typeVal === 'CV-2ml') ? 'CV2' : 'CV4';
            const qty = parseInt(row.querySelector('.cant-vials').value) || 1;
            
            // Validación
            if(!originVal || !originVal.includes('-')) {
                row.querySelector('.gen-freeze-code').value = "";
                return;
            }

            // Desglosar Origen: TPL32 (0) - 20DG (1) - NUM (2) - DATE (3)
            const parts = originVal.split('-');
            if(parts.length < 4) return; 

            // Extraer método limpio (quitar '20' al inicio)
            const methodRaw = parts[1]; // "20DG"
            const methodClean = methodRaw.replace('20', ''); // "DG"
            
            const flaskNum = parts[2]; // "2"
            const dateStr = parts[3]; // "290126"

            // Construir Base: TIPO-METODO-NUMFLASK-FECHA
            // Ej: CV2-DG-2-290126
            const baseCode = `${typeCode}-${methodClean}-${flaskNum}-${dateStr}`;
            
            // Generar lista desglosada con consecutivo final
            let codes = [];
            for(let i=1; i<=qty; i++) {
                codes.push(`${baseCode}-${i}`);
            }
            const codeString = codes.join('\n');

            const codeField = row.querySelector('.gen-freeze-code');
            if(codeField) {
                codeField.value = codeString;
                codeField.style.height = 'auto';
                codeField.style.height = (codeField.scrollHeight) + 'px';
            }
        }

        function toggleFreezeLocal() {
            const val = document.getElementById('freeze-select').value;
            document.getElementById('freeze-container').style.display = (val === 'Si') ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(document.getElementById('flask-table-body').children.length === 0) {
                addFlaskRowFiltered();
            }
        });
    </script>
</body>
</html>